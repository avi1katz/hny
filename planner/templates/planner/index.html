{% extends "planner/base.html" %}
{% block style %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    $(".completable").click(completeTask);
    var Calendar = FullCalendar.Calendar;
    var Draggable = FullCalendar.Draggable;


    var containerEl = document.getElementById('tasks');
    var calendarEl = document.getElementById('agenda');
    var checkbox = document.getElementById('drop-remove');

    // initialize the external events
    // -----------------------------------------------------------------

    new Draggable(containerEl, {
      itemSelector: '.task',
      eventData: function(eventEl) {
        console.log(eventEl);
        return {
          title: eventEl.querySelector(".description").innerText,
          duration: {minutes: eventEl.dataset.duration}
        };
      }
    });

    // initialize the calendar
    // -----------------------------------------------------------------

    var calendar = new Calendar(calendarEl, {
      initialView: 'timeGridDay',
<!--      slotDuration: {minutes: 15},-->
      weekNumbers: true,
      nowIndicator: true,
      editable: true,
      droppable: true, // this allows things to be dropped onto the calendar
      drop: function(info) {
        console.log(info);
        window.location='add_task/' + info.draggedEl.dataset.taskid +
        '/at_time/' + info.date.getHours()+':'+info.date.getMinutes();
      },
      eventClick: function(mouseClickInfo) {
        console.log(mouseClickInfo.event.id);
        mouseClickInfo.event.remove();
        window.location='delete_agenda_item/' + mouseClickInfo.event.id;
      },
      events:
      [
        {% for item in agenda.agenda_items.all %}
            {
                id: {{ item.id }},
                title: "{{ item.task.description }}",
                startTime: "{{ item.start_time|date:'H:i' }}",
                duration: {minutes: {{ item.task.minutes_to_complete }}}
            },
        {% endfor %}
      ]
    });

    calendar.render();
  });
</script>
<style>
tr.strikeout td:before {
    content: " ";
    position: absolute;
    top: 45%;
    left: 0;
    border-bottom: 1px solid #111;
    width: 100%;
}
#agenda {
    height: 90vh
}
</style>
{% endblock style %}
{% block title %}Planner{% endblock title %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <h1>Welcome to the Planner</h1>
    </div>
</div>
<div class="container">
    <div class="row">
        <div id="tasks" class="col">
            <h3>Tasks:</h3>
            <form id="task-form" method="post", action="/planner/" class="form-row" autocomplete="off">
                {% csrf_token %}
                <div class="col-9">
                    {{ form.description }}
                </div>
                <div class="col-2">
                    {{ form.minutes_to_complete }}
                </div>
                <div class="col-1">
                    <input class="btn btn-primary" type="submit" value="+">
                </div>
            </form>
            {% if tasks %}
            <table class="table table-hover">
                <tbody id="task_sortable" class="sortable tasks">
                    {% for task in tasks %}
                    <tr
                            class="completable task
                            {% if task.is_completed %} table-active strikeout{% endif %}
                            {% if task.agenda_items.all %} table-warning {% endif %}
                            "
                            data-taskid="{{task.id}}"
                            data-duration="{{task.minutes_to_complete}}">
                        <td class="col-8 description">{{ task.description  }}
                        {% if task.agenda_items.all %}
                            ({{ task.agenda_items.all.0.start_time }})
                        {% endif %}
                        </td>
                        <td class="col-2">({{ task.minutes_to_complete }}min)</td>
                        <td class="col-2"><a class="btn btn-sm btn-danger"
                                             data-confirm="Are you sure?"
                                             data-method="delete"
                                             href="delete_task/{{ task.id }}"
                                             rel="nofollow">X</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
                <br />
            </table>
            {% endif %}
        </div>
        <div id="agenda" class="col"></div>
    </div>

</div>

{% endblock content %}

{% block javascript %}
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
<script>
function completeTask(event){
    console.log('called completeTask()');
    console.log(event.currentTarget.dataset.taskid);
    window.location='toggle_complete_task/' + event.currentTarget.dataset.taskid;
}

function updateAgendaItem(event){
    originalValue = event.target.defaultValue;
    newValue = event.target.value;
    console.log(event.target.value);
    console.log(event.target.defaultValue);
    if ( originalValue !== newValue) {
        window.location='update_agenda_item/' + event.currentTarget.dataset.itemid + '/new_time/' + newValue;
    }
}

</script>
{% endblock javascript %}